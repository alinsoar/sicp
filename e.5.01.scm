
(load "aux/machine-sim")

(define (factorial n)
  (define (iter product counter)
    (if (> counter n)
        product
        (iter (* counter product)
              (+ counter 1))))
  (iter 1 1))

(define fact
  (make-machine
   '(n val)
   `((< ,<) (- ,-) (* ,*))
   '(controller
     (assign val (const 1))
     loop
     (test (op <) (reg n) (const 2))
     (branch (label done))
     (assign val (op *) (reg val) (reg n))
     (assign n (op -) (reg n) (const 1))
     (goto (label loop))
     done
     )))

(set-register-contents! fact 'n 5)
(start fact)
(display (get-register-contents fact 'val))


;;;;
;;;;
;;;;     DATAPATH
;;;;     =========================
;;;;
;;;;
;;;;                                *-------*
;;;;                                 \  1  /
;;;;                                  \   /
;;;;                                   \ /
;;;;                                    |
;;;;                       +------------|---------------------+
;;;;                       |  +---------+-----+   +---------+ |
;;;;                       |  |               |   |         | |
;;;;                       |  X K<-1     P<-1 X   |         | |
;;;;                K<-K+1 X  |               |   X P<-P*K  | |
;;;;                       |  |               |   |         | |
;;;;  +---------+      +---v--v--+         +--v---v--+      | |
;;;;  |    N    |      | counter |         | product |      | |
;;;;  +----+----+      +----+----+         +----+----+      | |
;;;;       |                |                   |           | |
;;;;       |   +------------+---------------+   +--> RESULT | |
;;;;       |   |            |               |   |           | |
;;;;   o---v---v--o     +---v---+         +-v---v-+         | |
;;;;  (    K>N?    )    |  1+   |         |   *   |         | |
;;;;   o----------o     +---+---+         +---+---+         | |
;;;;                        |                 |             | |
;;;;                        |                 +-------------+ |
;;;;                        +---------------------------------+
;;;;
;;;;
;;;;
;;;;
;;;;
;;;;
;;;;     CONTROL
;;;;     =========================
;;;;
;;;;
;;;;       +-------------+
;;;;       |    K<-1     |
;;;;       +------+------+
;;;;              |
;;;;       +------v------+
;;;;       |     P<-1    |
;;;;       +------+------+
;;;;              |
;;;;              V
;;;;             /\
;;;;            /  \
;;;;           /    \
;;;;          /      \  YES
;;;;     o--->\ K>N? /---------*  DONE
;;;;     |     \    /
;;;;     |      \  /
;;;;     |       \/
;;;;     |        |
;;;;     |        | NO
;;;;     |        |
;;;;     | +------v------+
;;;;     | |   P<-P*K    |
;;;;     | +------+------+
;;;;     |        |
;;;;     | +------v------+
;;;;     | |    K<-K+1   |
;;;;     | +-------+-----+
;;;;     |         |
;;;;     o---------+
;;;;


